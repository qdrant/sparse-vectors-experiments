use crate::sparse_index::common::types::{DimId, DimWeight};

#[derive(Debug, PartialEq, Clone)]
pub struct SparseVector {
    pub indices: Vec<DimId>,
    pub weights: Vec<DimWeight>,
}

impl SparseVector {
    pub fn new(indices: Vec<DimId>, weights: Vec<DimWeight>) -> SparseVector {
        SparseVector { indices, weights }
    }

    // Can't assume the vectors are aligned
    pub fn dot_product(&self, other: &SparseVector) -> f32 {
        // find shorter vector to place in outer position
        let (outer, inner) = if self.indices.len() > other.indices.len() {
            (other, self)
        } else {
            (self, other)
        };

        let mut result = 0.0;
        // dot product
        for (dim, weight) in outer.indices.iter().zip(&outer.weights) {
            let index_in_inner = inner.indices.iter().position(|&x| x == *dim);
            if let Some(i) = index_in_inner {
                // dot product
                result += weight * inner.weights[i];
            }
        }

        result
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_dot_product_aligned() {
        let v1 = SparseVector::new(vec![1, 2, 3], vec![1.0, 2.0, 3.0]);
        let v2 = SparseVector::new(vec![1, 2, 3], vec![1.0, 2.0, 3.0]);

        assert_eq!(v1.dot_product(&v2), 14.0);
        assert_eq!(v2.dot_product(&v1), 14.0);
    }

    #[test]
    fn test_dot_product_missing() {
        let v1 = SparseVector::new(vec![1, 2, 3], vec![1.0, 2.0, 3.0]);
        let v2 = SparseVector::new(vec![1, 3], vec![1.0, 2.0]);

        assert_eq!(v1.dot_product(&v2), 7.0);
        assert_eq!(v2.dot_product(&v1), 7.0);
    }

    #[test]
    fn test_dot_product_splade() {
        let query = SparseVector::new(vec![0, 1000, 2000, 3000], vec![1.0, 0.2, 0.9, 0.5]);
        let doc = SparseVector::new(
            vec![
                10026, 1006, 10083, 10214, 10269, 10403, 10602, 10887, 10912, 11084, 11099, 11377,
                11397, 12250, 12262, 12520, 12670, 12790, 12902, 13055, 13073, 13075, 13496, 13510,
                13809, 13897, 13898, 13948, 13964, 14146, 14207, 14270, 14472, 14573, 14808, 14926,
                14947, 15115, 15370, 15454, 15488, 16006, 16391, 16411, 16599, 16789, 16818, 17595,
                18292, 18824, 19089, 19227, 19396, 19528, 19734, 1998, 2000, 2002, 2007, 2010,
                2013, 20133, 2014, 2016, 2021, 2022, 2027, 2037, 2040, 2041, 2044, 2047, 2050,
                2056, 20590, 2072, 2080, 2082, 2083, 2086, 2096, 2103, 2118, 2128, 2138, 2143,
                2145, 2153, 2155, 2160, 2166, 2175, 2191, 2198, 21991, 22001, 2214, 2215, 22210,
                22404, 2259, 2267, 2269, 2273, 2299, 2330, 2359, 2360, 2362, 2365, 2370, 2377,
                2388, 2406, 2408, 2409, 24119, 24141, 24211, 2425, 2441, 2442, 2448, 2449, 24555,
                2468, 2482, 2483, 2485, 2496, 2501, 2517, 2564, 2567, 2571, 25850, 2586, 2605,
                26098, 2636, 2648, 2666, 2684, 27006, 2701, 2745, 2753, 2767, 2770, 2772, 27757,
                27829, 2783, 2785, 27885, 27928, 27935, 27942, 2816, 28262, 2839, 2878, 2891, 2902,
                2905, 2928, 2945, 29536, 3000, 3008, 3122, 3129, 3153, 3185, 3190, 3232, 3235,
                3236, 3276, 3306, 3308, 3309, 3364, 3387, 3412, 3428, 3459, 3468, 3505, 3510, 3530,
                3531, 3566, 3604, 3610, 3611, 3655, 3656, 3696, 3765, 3784, 3814, 3818, 3836, 3883,
                3897, 3910, 3942, 3970, 4028, 4034, 4041, 4054, 4066, 4148, 4172, 4188, 4228, 4237,
                4256, 4307, 4318, 4336, 4339, 4393, 4440, 4474, 4484, 4509, 4514, 4550, 4608, 4646,
                4669, 4679, 4685, 4754, 4757, 4775, 4825, 5011, 5030, 5086, 5103, 5138, 5149, 5208,
                5216, 5246, 5306, 5386, 5483, 5503, 5534, 5542, 5564, 5595, 5637, 5661, 5727, 5740,
                5795, 5826, 5889, 5914, 5978, 5993, 6062, 6090, 6298, 6330, 6338, 6378, 6396, 6427,
                6510, 6513, 6611, 6667, 6687, 6736, 6801, 6813, 6898, 6934, 7068, 7118, 7133, 7136,
                7143, 7180, 7467, 7472, 7523, 7618, 7668, 7855, 7884, 7919, 7999, 8046, 8054, 8081,
                8196, 8275, 8323, 8340, 8481, 8583, 8628, 8656, 8657, 8887, 9027, 9060, 9075, 9152,
                9169, 9196, 9209, 9287, 9305, 9344, 9388, 9394, 9458, 9467, 9504, 9619, 9804,
            ],
            vec![
                0.20709501,
                0.33786982,
                0.29183367,
                0.5767024,
                0.4006807,
                0.4161787,
                0.21292448,
                0.54874444,
                0.19583797,
                0.009968498,
                0.21621817,
                0.906986,
                0.20749857,
                0.6975671,
                2.1821053,
                0.27575436,
                2.7537854,
                2.1903841,
                2.0647125,
                0.047571965,
                1.7308105,
                1.5420401,
                0.47393036,
                1.1178291,
                1.9953969,
                0.09336563,
                1.6016628,
                0.7177344,
                1.0400413,
                0.21955885,
                1.9253669,
                0.07938108,
                0.22528587,
                1.4796642,
                1.1902142,
                1.6412915,
                0.5609933,
                0.52446544,
                0.34825543,
                0.21080956,
                0.57771564,
                0.43570304,
                0.001918501,
                0.26332963,
                1.1601439,
                0.062065315,
                0.1524036,
                1.1254185,
                0.30765405,
                1.6437141,
                0.44928524,
                0.033642888,
                1.2425768,
                0.67309374,
                0.54700977,
                0.031369578,
                1.986644,
                0.38758963,
                0.08346066,
                0.31899345,
                0.15624812,
                1.4080545,
                0.5663961,
                0.908815,
                0.0884588,
                0.30338225,
                0.01797107,
                0.3233572,
                0.29709035,
                0.2710232,
                0.48608148,
                0.6770874,
                0.40916076,
                0.32452697,
                1.6724777,
                0.6037175,
                0.30922216,
                0.5827729,
                0.7740887,
                0.5308516,
                0.13852116,
                0.5628829,
                0.5481717,
                0.41601744,
                0.20248182,
                0.73712105,
                0.781101,
                0.74176764,
                1.1512175,
                0.61718196,
                0.7154347,
                0.5177006,
                0.5111599,
                0.9709107,
                0.73878133,
                1.5527868,
                0.38015822,
                0.8156048,
                0.6751352,
                0.24611332,
                0.80371267,
                0.6089206,
                0.9752328,
                0.14800945,
                0.2769385,
                0.3466829,
                0.75458825,
                0.42262056,
                1.0103976,
                0.004315706,
                0.26310542,
                0.23777296,
                0.58427864,
                0.36169866,
                0.66819245,
                0.2512713,
                2.3724437,
                1.6165532,
                1.2984369,
                0.49509645,
                0.058717586,
                0.42052332,
                0.5714033,
                0.8720994,
                0.7231925,
                0.41431653,
                0.52692163,
                0.8393547,
                0.31553409,
                1.0222318,
                0.35391074,
                0.52543485,
                0.8443753,
                0.72307277,
                0.41880012,
                1.8091457,
                0.5913551,
                0.87418485,
                0.33650655,
                0.3703777,
                0.28807873,
                0.84923214,
                0.6970038,
                1.9964364,
                0.7678043,
                1.3417138,
                0.23521252,
                0.17625715,
                0.09116593,
                0.7241811,
                1.3783234,
                0.61293304,
                0.49054533,
                0.62674946,
                0.29247025,
                0.5357756,
                0.90870625,
                1.6199085,
                0.7921671,
                0.43009043,
                0.72431874,
                0.12304616,
                1.3162849,
                0.8029317,
                0.10081247,
                0.83601844,
                0.74218476,
                1.0294614,
                1.9582971,
                0.83625144,
                0.82550645,
                0.82997245,
                0.012805141,
                0.10577,
                1.4594594,
                0.13477892,
                1.3388102,
                0.7022384,
                0.30248728,
                0.9972674,
                0.8497252,
                0.19488323,
                0.95425725,
                0.047932126,
                0.2659375,
                0.6611547,
                1.0946106,
                0.6035122,
                0.28945446,
                1.3642907,
                0.264773,
                0.54160285,
                0.41695264,
                0.8500591,
                0.49383035,
                0.67481863,
                0.1008364,
                1.1030396,
                0.9163408,
                0.3928407,
                0.22466531,
                2.2133133,
                0.8918727,
                0.32214266,
                0.028881714,
                0.6578436,
                0.11877976,
                0.0065578492,
                0.587368,
                0.2760529,
                0.9115104,
                0.45752883,
                1.0848469,
                0.42086452,
                0.7859212,
                1.2549703,
                0.9464217,
                0.35973376,
                0.11571312,
                0.96488017,
                0.83845365,
                1.475584,
                0.76676494,
                0.041320335,
                0.19190702,
                0.0695659,
                0.43445128,
                0.49168217,
                0.7246214,
                0.55740803,
                0.8384277,
                0.5483067,
                0.28815487,
                0.03185514,
                1.9759372,
                0.13073897,
                2.028204,
                0.4834806,
                2.0785685,
                1.2600337,
                1.2847819,
                1.2175583,
                0.6002742,
                0.6395236,
                0.37937337,
                0.9565764,
                0.084026255,
                1.0616938,
                0.4772671,
                0.586933,
                0.23120831,
                1.3043746,
                1.1545026,
                0.5779685,
                0.07633371,
                0.7907169,
                1.1006938,
                0.16592023,
                0.18427125,
                0.5711459,
                1.1113793,
                0.06806248,
                0.7608441,
                0.66831094,
                0.4968986,
                0.49038786,
                0.54559994,
                0.009645406,
                1.3112589,
                0.7114469,
                0.16931398,
                0.98486644,
                0.8687554,
                0.69208884,
                0.70172244,
                1.0465,
                0.095367745,
                0.10497103,
                0.6932645,
                0.092926756,
                0.49326667,
                0.13294014,
                0.05151629,
                0.7818486,
                0.44792378,
                2.1139011,
                0.928327,
                1.0168003,
                0.058833703,
                0.8516156,
                0.48721167,
                0.33022192,
                0.70643663,
                0.2747472,
                0.9268022,
                0.07162928,
                1.5846137,
                1.2243909,
                0.07117775,
                0.04157755,
                0.8506805,
                0.26600885,
                0.84256434,
                0.58240336,
                0.34992468,
                0.6826998,
                0.19271372,
                0.1277743,
                0.6004591,
                0.11702999,
                0.82899666,
                1.7333941,
                0.13260862,
                1.4246459,
                1.38317,
                0.05176207,
                1.5799004,
                0.35165393,
                0.1339733,
                0.18126255,
                0.28033364,
                1.8050249,
                1.0580095,
                0.8591517,
                0.39148262,
                0.7270634,
                0.18399905,
                0.0811089,
                0.06310088,
                0.15760121,
            ],
        );

        assert_eq!(query.dot_product(&doc), 2.7671282);
        assert_eq!(doc.dot_product(&query), 2.7671282);
    }
}
